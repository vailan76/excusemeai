/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. Each user has a dedicated document in the
 * top-level `/users` collection, and they are only permitted to access and modify their own document. This prevents
 * any user from viewing or tampering with another user's data.
 *
 * Data Structure: All user-specific data is stored under the path `/users/{userId}`, where the document ID `{userId}`
 * must match the authenticated user's Firebase UID. This structure is simple, secure, and performant.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only create, read, update, or delete their own user document.
 * - Disallowing User Enumeration: The `list` permission on the `/users` collection is explicitly denied. This is a critical
 *   security measure to prevent malicious actors from downloading a list of all application users.
 * - Self-Creation: Users are permitted to create their own user document, which is a necessary step during sign-up.
 *   The document's internal `id` field must match the user's UID upon creation to ensure data consistency.
 *
 * Denormalization for Authorization: The security model relies on path-based ownership. The user's UID is present
 * in the document path (`/users/{userId}`), which allows for fast and inexpensive authorization checks without needing
 * to read any other documents (`get()` calls).
 *
 * Structural Segregation: This principle is not currently applicable as the data model consists of a single collection
 * of private user documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the requested document's ID.
     * This is the primary function for enforcing user ownership.
     * @param userId The document ID, representing the user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for safe updates and deletes.
     * Prevents operations on documents that do not exist.
     * @param userId The document ID, representing the user's UID.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates the creation of a new user document.
     * Ensures the creator is the owner and that the internal 'id' field matches the UID in the path.
     * This establishes an immutable link between the document and the user.
     * @param userId The document ID, representing the user's UID.
     */
    function isCreatingValidUserDoc(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates an update to a user document.
     * Ensures the user is the owner and that the internal 'id' field is not being changed.
     * This prevents re-assigning the document to a different user.
     * @param userId The document ID, representing the user's UID.
     */
    function isUpdatingValidUserDoc(userId) {
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }


    /**
     * @description A user can create, read, update, and delete their own user document. Listing all users is explicitly forbidden.
     * @path /users/{userId}
     * @allow (create) An authenticated user with UID 'user123' creating a new document at `/users/user123`.
     * @allow (get) An authenticated user with UID 'user123' reading their own document at `/users/user123`.
     * @deny (list) Any user, authenticated or not, attempting to list documents from the `/users` collection.
     * @deny (get) An authenticated user with UID 'user456' trying to read `/users/user123`.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      // READ: A user can only get their own document. Listing users is disallowed to prevent data leakage.
      allow get: if isOwner(userId);
      allow list: if false;

      // WRITE: A user can create their own document (for sign-up), update it, and delete it (for account deletion).
      allow create: if isCreatingValidUserDoc(userId);
      allow update: if isUpdatingValidUserDoc(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}